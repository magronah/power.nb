---
title: "Simulation for microbiome power analysis"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Simulation for microbiome power analysis}
  %\VignettePackage{power.nb}
  %\VignetteEngine{knitr::rmarkdown}
---



## Introduction 


**Installation**

Install the package from GitHub using `devtools`:

```{r, eval=FALSE}
install.packages("devtools")
devtools::install_github("magronah/power.nb")
```

### Overview

This package allows you to:

- Fit statistical models to microbiome count data.

- Simulate realistic count datasets with different effect sizes.

- Test for differential abundance.

- Estimate power per taxon.

- Explore sample size and effect size sensitivity.


### Data simulation for power estimation

We would need to simulate microbiome data in order to estimate statistical power at the level of individual taxon.  The simulation framework implemented in `power.nb` is Mixture of Gaussian Mixture Model proposed in the paper by [Agronah and Bolker](https://doi.org/10.1371/journal.pone.0318820). There are one of two ways to obtain the parameters of the Mixture of Gaussian Mixture Model for data simulation. 

1) Users can either pre-specify a set of parameters 
**OR** 
2)  Estimating these parameters from existing datasets 


#### Prespecifing parameters for the Gaussian model


#### Estimating Gaussian parameters from existing data

The following steps outlines the process for estimating parameters if you have a dataset. To ensure that results are applicable to the study you intend conducting. 

similar to the one you intend using for your study. 
Use your microbiome data to fit a Gaussian mixture model:


##### Data preprocessing 
Low abundant tax exhibit high variability, posing challenges in detecting significant differences between groups cite{m}. Pre-filtering steps, as is routinely done in differential abundance analysis, is used to filter out these low abundant taxa. In this vignette, we filter out taxa with less that 10 count in less that 5 samples. 

```{r, eval=FALSE}
# load library
library(power.nb) 

#filter out low abundant taxa
filter_data  = filter_low_count(countdata = data,
                                metadata  = metadata,
                                abund_thresh = 10,
                                sample_thresh = 5,
                                sample_colname = "SampleID",
                                group_colname  = "Groups")

head(filter_data)
```

##### Model Fitting

```{r, eval=FALSE}
#Fit log mean count
logmean    =  log(rowMeans(filter_data))
logmeanFit =  logmean_fit(logmean, sig = 0.05, 
                         max.comp = 4, max.boot = 100)
names(logmeanFit)

#Estimate foldchange from Deseq
foldchange_est <- deseqfun(countdata = data,
                           metadata  = metadata,
                          alpha_level = 0.1,
                          ref_name  = "Control",
                          group_colname = "Groups",
                          sample_colname = "SampleID")

logfoldchange =  foldchange_est$log2FoldChange

## Fit foldchange from Deseq
logfoldchangeFit <- logfoldchange_fit(logmean,
                                       logfoldchange,
                                       ncore = 2,
                                       max_sd_ord = 2,
                                       max_np = 5,
                                       minval = -5,
                                       maxval = 5,
                                       itermax = 100,
                                       NP = 800,
                                       seed = 100)

logfoldchangeFit
```



 


```{r, echo=FALSE}
library(knitr)
library(kableExtra)

# Example data (two rows like in your LaTeX version)
df <- data.frame(
  `Data description` = c("Example row 1", "Example row 2"),
  n1 = c(5, 5),
  mu1 = c("(2,3,4,5,7)", "(2,3,4,5,7)"),
  sigma1 = c("(2,3,4,5,7)", "(2,3,4,5,7)"),
  p1 = c("(2,3,4,5,7)", "(2,3,4,5,7)"),
  n2 = c(5, 5),
  mu2 = c("(2,3,4,5,7)", "(2,3,4,5,7)"),
  sigma2 = c("(2,3,4,5,7)", "(2,3,4,5,7)"),
  p2 = c("(2,3,4,5,7)", "(2,3,4,5,7)"),
  fx = c("(2,3,4,5,7)", "(2,3,4,5,7)")
)

kbl(df, booktabs = TRUE, longtable = TRUE,
    caption = "Data description and parameter estimates") %>%
  kable_styling(latex_options = c("hold_position", "repeat_header")) %>%
  add_header_above(c(" " = 1, "Log mean count" = 4, "Log foldchange" = 5)) %>%
  add_header_above(c(" " = 1, "Parameters" = 9)) # optional extra grouping

```


 

## Simulating Data


```{r, eval=FALSE}
sim <- simulate_data(fit,
                     n_taxa = 1000,
                     n_per_group = c(30, 30),
                     fold_changes = c(1.5, 2, 4),
                     nsim = 100)
```



## Estimating Power
Calculate power for each taxon as the proportion of significant detections:



## Sample Size Estimation
